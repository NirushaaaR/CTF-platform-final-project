{% extends 'base.html' %} {% load static %} {% load custom_filters %} {% load humanize %}
{% block content %}
<div class="container">
  <h2 class="mt-4">{{room.title}}</h2>
  <p>
    {% for require_room in room.prerequisites.all %}
    {% if forloop.first %}ควรทำ {% endif %}
    <a href="{{require_room.get_absolute_url}}">&lt;{{require_room}}&gt;</a>
    {% if forloop.last %} ก่อน{% endif %}
    {% endfor %}
  </p>
  <hr>
  {{room.description|safe}}

  {% if is_finish %}
  <div class="card mb-3 border-warning box-shadow">
    <h3 class="card-header border-warning">บทสรุป</h3>
    <div class="card-body">
      <div class="card-text">
        {{room.conclusion|safe}}
      </div>
      <div>
        {% for next_room in room.next_rooms.all %}
        {% if forloop.counter == 1 %}ถัดไป: {% endif %}
        <a href="{{next_room.get_absolute_url}}">&lt;{{next_room}}&gt;</a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  <hr>

  {% for task in tasks %}
  <div id="card_{{task.id}}"
    class="card my-3 {% if task.task_number in user_answered_tasks %}border-success{% endif %}">
    <div id="card_header_{{task.id}}"
      class="card-header d-flex justify-content-between {% if task.task_number in user_answered_tasks %}border-success{% endif %} box-shadow">
      <h3>{{task.task_number}} - {{task.title}}</h3>
      <div class="align-self-end pb-1">{{task.points}} points</div>
    </div>
    <div class="card-body">
      <div class="card-text">
        {{task.description|safe}}
      </div>
      <hr>
      <form id="formtask_{{task.id}}" class="task-form" action="{% url 'enter_flag' room.id %}" method="post">
        <div class="form-row align-items-center">
          <div class="col-md-11">
            {% csrf_token %}
            <input type="hidden" name="task_id" value="{{task.id}}" />
            <input class="form-control" type="text" name="flag" placeholder="{{task.flag|censor_flag}}" />
          </div>
          <div class="col-md-1 text-center">
            <button type="submit" class="btn btn-success">Submit</button>
          </div>
        </div>
      </form>
      <div class="d-inline-flex mt-2">
        {% for hint in task.hints.all %}
        <button type="button" class="btn mr-2" data-toggle="modal" data-target="#task{{task.id}}-hint{{hint.id}}">
          คำใบ้ {{forloop.counter}}
        </button>
        <div class="modal fade" id="task{{task.id}}-hint{{hint.id}}" tabindex="-1" role="dialog"
          aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">คำใบ้ {{forloop.counter}}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                {{hint.hint}}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% if task.task_number in user_answered_tasks %}
    <div class="card-footer border-success text-success text-right">
      <i class="fas fa-check"></i> cleared {{user_answered_tasks|get_dict_value:task.task_number|naturaltime}}
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
<div class="overlay"></div>
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/ajaxLoadingSpinner.js' %}"></script>
<script>
  $(".task-form").submit(function (e) {
    e.preventDefault();

    const form = $(this);
    const url = form.attr('action');
    const task_id = $('input[name="task_id"]', form).val();

    $.ajax({
      type: "POST",
      url: url,
      data: form.serialize(),
      success: function (data) {
        alert(data.message);
        console.log(data);
        if (data.correct) {
          $("#card_" + task_id).addClass("border-success");
          $("#card_header_" + task_id).addClass("border-success");
          $("#card_" + task_id).append(`<div class="card-footer border-success text-success text-right">
            <i class="fas fa-check"></i> cleared </div>`);
        }
        
      }
    });
  });
</script>
{% endblock %}