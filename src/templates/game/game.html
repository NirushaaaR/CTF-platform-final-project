{% extends 'base.html' %} {% load static %}
{% block content %}
<div class="container">
    <h1>{{game}}</h1>
    <p>Time remain <span id="days"></span> <span id="hours"></span> <span id="minutes"></span> <span
            id="seconds"></span> </p>
    <div id='chart-area'></div>
    <hr>
    <div id="challenges">
        {% for challenge in challenges %}
        <p>{{challenge.docker}}</p>
        <p>Cleared <span id="challenge_cleared_{{challenge.id}}"></span>/{{challenge.flag_count}}</p>
        <form class="form-challenge" id="challenge_{{challenge.id}}" action="{% url 'enter_challenge_flag' %}"
            method="POST">
            {% csrf_token %}
            <input type="hidden" name="challenge_id" value="{{challenge.id}}">
            <label for="flag">Enter Flag</label>
            <input type="text" name="flag">
            <button class="submit-flag">Submit</button>
        </form>
        <hr>
        {% endfor %}
    </div>
</div>
<div class="overlay"></div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/ajaxLoadingSpinner.js' %}"></script>
{{challenges|json_script:"challenges-data"}}
<script>
    const gameID = "{{game.id}}";
    let score_data;
    const gameSocket = new WebSocket(
        `ws://${window.location.host}/ws/game/${gameID}/`
    );
    gameSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("onmessage", data)
        // console.log(data);
        // users_score = data.data;
        if (data.type === "initial_score") {
            score_data = data.data;
            console.log(score_data)
        }
    }
    gameSocket.onclose = function (e) {
        console.error("Game Socket Close unexpected", e);
    }

    const challenges = JSON.parse(document.getElementById('challenges-data').textContent);
    function updateClearedFlag() {
        challenges.forEach(function (c) {
            $("#challenge_cleared_" + c.id).html(c.cleared_flag);
        });
    }
    updateClearedFlag();


    $(".form-challenge").submit(function (e) {
        e.preventDefault();
        const form = $(this);
        const url = form.attr('action');

        const challenge_id = $('input[name="challenge_id"]', $(this)).val();

        $.ajax({
            type: "POST",
            url: url,
            data: form.serialize(),
            success: function (data) {
                alert(data.message);
                if (data.correct) {
                    gameSocket.send(JSON.stringify({
                        "type": "update_score"
                    }));
                    const idx = challenges.findIndex(obj => obj.id == challenge_id);
                    challenges[idx].cleared_flag += 1;
                    updateClearedFlag();
                }
            }
        });
    });

    function makeTimer() {
        let endTime = new Date('{{game.end|date:"U"}}' * 1000);
        endTime = (Date.parse(endTime) / 1000);

        const now = (Date.parse(new Date()) / 1000);

        let timeLeft = endTime - now;

        let days = Math.floor(timeLeft / 86400);
        let hours = Math.floor((timeLeft - (days * 86400)) / 3600);
        let minutes = Math.floor((timeLeft - (days * 86400) - (hours * 3600)) / 60);
        let seconds = Math.floor((timeLeft - (days * 86400) - (hours * 3600) - (minutes * 60)));

        if (hours < "10") { hours = "0" + hours; }
        if (minutes < "10") { minutes = "0" + minutes; }
        if (seconds < "10") { seconds = "0" + seconds; }

        $("#days").html(days + " Days");
        $("#hours").html(hours + " Hours");
        $("#minutes").html(minutes + " Minutes");
        $("#seconds").html(seconds + " Seconds");

    }
    makeTimer();
    setInterval(makeTimer, 1000);

    var options = {
        chart: {
            height: 250,
            type: 'line'
        },
        xaxis: {
            categories: [1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999]
        },
        series: [{
            name: 'sales1',
            data: [30, 40, 35, 50, 49, 60, 70, 91, 125]
        },
        {
            name: 'sales1',
            data: [32, 44, 39, 58, 47, 61, 65, 72, 100]
        }],
        
    }

    var chart = new ApexCharts(document.querySelector("#chart-area"), options);

    chart.render();
</script>
{% endblock %}