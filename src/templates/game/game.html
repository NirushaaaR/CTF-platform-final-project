{% extends 'base.html' %} {% load static %}
{% block content %}
<div class="container">
    <h1>{{game}}</h1>
    {% if game.period %}
    {% if game.period.is_game_end %}
    <p>ช่วงเวลาของเกมหมดลงแล้วแต่คุณยังตอบ</p>
    {% else %}
    <p>เวลาที่เหลืออยู่ <span id="days"></span> <span id="hours"></span> <span id="minutes"></span> <span
            id="seconds"></span> </p>
    {% endif %}
    {% endif %}
    <div class="chart-title">Top 10 Users Score</div>
    <div id='chart-area'></div>
    <hr>
    <div id="challenges">
        {% for challenge in challenges %}
        <p>{{challenge.docker_image}} - <a href="{{challenge.url}}">{{challenge.url}}</a></p>
        <p>{{challenge.description|safe}}</p>
        <hr>
        {% endfor %}
    </div>

    <div class="flag-enter">
        <form class="form-challenge" id="challenge_{{challenge.id}}" action="{% url 'enter_challenge_flag' %}"
            method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label for="flag">ใส่ Flag</label>
                <input class="input-challenge-flag form-control" type="text" name="flag"
                    placeholder="FLAG{........................}" required>
            </div>
            <button class="submit-flag btn btn-primary">Submit</button>
        </form>

        <table id="allflags" class="table table-bordered my-4">
            <thead>
                <tr>
                    <th scope="col">ชื่อ</th>
                    <th scope="col" colspan="2">คำอธิบาย</th>
                    <th scope="col">สถานะ</th>
                    <th scope="col">แต้มที่ได้</th>
                </tr>
            </thead>
            <tbody>
                {% for flag in flags %}
                <tr id="flag_{{flag.id}}">
                    <td>{{flag.name}}</td>
                    <td colspan="2">{{flag.explanation}}</td>
                    <td class="flag-status {% if flag.answered %}text-success{% else %}text-danger{% endif %}">
                        {{flag.status}}</td>
                    <td class="flag-point">{% if flag.answered %}{{flag.points_gained}}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="overlay"></div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/ajaxLoadingSpinner.js' %}"></script>
<script>
    const date_list = [];
    var chartOptions = {
        chart: {
            height: 350,
            type: 'line',
        },
        xaxis: {
            type: 'numeric',
            labels: {
                show: false
            },
            tooltip: {
                enabled: false
            }
        },
        dataLabels: {
            enabled: false
        },
        series: [],
        tooltip: {
            x: {
                formatter: function (val, { dataPointIndex }) {
                    const date = new Date(date_list[dataPointIndex]);
                    let minute = date.getMinutes();
                    minute = minute < 10 ? `0${minute}` : minute;
                    return `${date.toDateString()} at ${date.getHours()}:${minute}`;
                }
            }
        }
    }

    var chart = new ApexCharts(
        document.querySelector("#chart-area"),
        chartOptions
    );

    chart.render();

    async function get_top10_score() {
        const res = await fetch("{% url 'game_score' game.id %}");
        const json = await res.json();
        console.log("get_top10_score", json);

        const score_data = [];
        // update graph
        json.data.forEach((d, index) => {
            const idx = score_data.findIndex(s => s.name === d.username);
            if (idx >= 0) {
                // add to existing user data
                score_data[idx].current_score += d.points_gained

                for (let i = 0; i < score_data.length; i++) {
                    score_data[i].data.push(score_data[i].current_score);
                }

            } else {
                // update others user data
                for (let i = 0; i < score_data.length; i++) {
                    score_data[i].data.push(score_data[i].current_score);
                }
                const newUserSeries = {
                    name: d.username,
                    data: [...date_list.map(dl => 0), d.points_gained],
                    current_score: d.points_gained,
                }
                // add new user data
                score_data.push(newUserSeries);
                chart.appendSeries(newUserSeries);
            }
            date_list.push(d.answered_at);
        });

        score_data.sort((a, b) => b.current_score - a.current_score);
        chart.updateSeries(score_data);
    }

    get_top10_score();

    // user answer the flag
    $(".form-challenge").submit(function (e) {
        e.preventDefault();
        const form = $(this);
        const url = form.attr('action');

        $.ajax({
            type: "POST",
            url: url,
            data: form.serialize(),
            success: function (data) {
                alert(data.message);
                $('.input-challenge-flag').val('');
                if (data.correct) {
                    // location.reload();
                    get_top10_score();
                    // find the right flag and update it
                    const flagInfo = $("#flag_" + data.flagid);
                    // status to "Solved "+ "\u2713"
                    const flagStatus = flagInfo.find(".flag-status");
                    flagStatus.text("Solved " + "\u2713");
                    flagStatus.removeClass("text-danger");
                    flagStatus.addClass("text-success");
                    // point gain update
                    flagInfo.find(".flag-point").text(data.points_gained);
                }
            }
        });
    });

</script>
{% if game.period %}
<script>
    function makeTimer() {
        let endTime = new Date("{{game.period.end|date:'U'}}" * 1000);
        endTime = (Date.parse(endTime) / 1000);

        const now = (Date.parse(new Date()) / 1000);

        let timeLeft = endTime - now;

        let days = Math.floor(timeLeft / 86400);
        let hours = Math.floor((timeLeft - (days * 86400)) / 3600);
        let minutes = Math.floor((timeLeft - (days * 86400) - (hours * 3600)) / 60);
        let seconds = Math.floor((timeLeft - (days * 86400) - (hours * 3600) - (minutes * 60)));

        if (hours < "10") { hours = "0" + hours; }
        if (minutes < "10") { minutes = "0" + minutes; }
        if (seconds < "10") { seconds = "0" + seconds; }

        $("#days").html(days + " Days");
        $("#hours").html(hours + " Hours");
        $("#minutes").html(minutes + " Minutes");
        $("#seconds").html(seconds + " Seconds");

    }
    makeTimer();
    setInterval(makeTimer, 1000);

</script>
{% endif %}
{% endblock %}