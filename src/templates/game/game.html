{% extends 'base.html' %} {% load static %}
{% block content %}
<div class="container">
    <h1>{{game}}</h1>
    {% if not game_ends %}
    <p>Time remain <span id="days"></span> <span id="hours"></span> <span id="minutes"></span> <span
            id="seconds"></span> </p>
    {% else %}
        <p>Game Already Ends But you can still answer the flag</p>
    {% endif %}
    <div class="chart-title">Top 10 Users Score</div>
    <div id='chart-area'></div>
    <hr>
    <div id="challenges">
        {% for challenge in challenges %}
        <p>{{challenge.docker}} - <a href="{{challenge.url}}">{{challenge.url}}</a></p>
        <p>{{challenge.description|safe}}</p>
        <p>Cleared <span id="challenge_cleared_{{challenge.id}}"></span>/{{challenge.flag_count}}</p>
        <form class="form-challenge" id="challenge_{{challenge.id}}" action="{% url 'enter_challenge_flag' %}"
            method="POST">
            {% csrf_token %}
            <input type="hidden" name="challenge_id" value="{{challenge.id}}">
            <label for="flag">Enter Flag</label>
            <input class="input-challenge-flag" type="text" name="flag" required>
            <button class="submit-flag">Submit</button>
        </form>
        <hr>
        {% endfor %}
    </div>
</div>
<div class="overlay"></div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/ajaxLoadingSpinner.js' %}"></script>
{{challenges|json_script:"challenges-data"}}
<script>
    const gameID = "{{game.id}}";
    var chartOptions = {
        chart: {
            height: 350,
            type: 'line',
        },
        xaxis: {
            type: 'numeric',
            labels: {
                show: false
            },
            tooltip: {
                enabled: false
            }
        },
        dataLabels: {
            enabled: false
        },
        series: [],
        tooltip: {
            x: {
                formatter: function (val, { dataPointIndex }) {
                    const date = new Date(date_list[dataPointIndex]);
                    let minute = date.getMinutes();
                    minute = minute < 10 ? `0${minute}` : minute;
                    return `${date.toDateString()} at ${date.getHours()}:${minute}`;
                }
            }
        }
    }

    var chart = new ApexCharts(
        document.querySelector("#chart-area"),
        chartOptions
    );

    chart.render();

    let date_list = [];
    const gameSocket = new WebSocket(
        `ws://${window.location.host}/ws/game/${gameID}/`
    );

    gameSocket.onopen = function (e) {
        console.log("open", e)
        // $(".input-challenge-flag").each(function(i, e){
        //     e.removeAttribute("disabled");
        //     e.setAttribute("placeholder", "Enter Flag Here");
        // })
    }

    gameSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("onmessage", data)

        if (data.type === "get_score") {
            const score_data = [];
            date_list = [];
            data.data.forEach((d, index) => {
                const idx = score_data.findIndex(s => s.name === d.username);
                if (idx >= 0) {
                    // add to existing user data
                    score_data[idx].current_score += d.points_gained

                    for (let i = 0; i < score_data.length; i++) {
                        score_data[i].data.push(score_data[i].current_score);
                    }

                } else {
                    // update others user data
                    for (let i = 0; i < score_data.length; i++) {
                        score_data[i].data.push(score_data[i].current_score);
                    }

                    // add new user data
                    score_data.push({
                        name: d.username,
                        data: [...date_list.map(dl => 0), d.points_gained],
                        current_score: d.points_gained,
                    })
                }
                date_list.push(d.answered_at);
            });

            score_data.sort((a, b) => b.current_score - a.current_score);
            console.log(score_data);
            chart.updateSeries(score_data);
        } else if (data.type === "answer_flag") {
            // $("body").removeClass("loading");

        }
    }
    gameSocket.onclose = function (e) {
        console.error("Game Socket Close unexpected", e);
    }

    const challenges = JSON.parse(document.getElementById('challenges-data').textContent);
    function updateClearedFlag() {
        challenges.forEach(function (c) {
            $("#challenge_cleared_" + c.id).html(c.cleared_flag);
        });
    }
    updateClearedFlag();


    $(".form-challenge").submit(function (e) {
        e.preventDefault();
        const form = $(this);
        const url = form.attr('action');

        const challenge_id = $('input[name="challenge_id"]', $(this)).val();
        const flag = $('input[name="flag"]', $(this)).val();

        // gameSocket.send(JSON.stringify({
        //     type: "answer_flag",
        //     user_id: "{{request.user.id}}",
        //     challenge_id: challenge_id,
        //     flag: flag
        // }));

        // $("body").addClass("loading");

        $.ajax({
            type: "POST",
            url: url,
            data: form.serialize(),
            success: function (data) {
                alert(data.message);
                if (data.correct) {
                    gameSocket.send(JSON.stringify({
                        type: "update_score",
                    }));
                    const idx = challenges.findIndex(obj => obj.id == challenge_id);
                    challenges[idx].cleared_flag += 1;
                    updateClearedFlag();
                }
            }
        });
    });

</script>
{% if not game_ends %}
<script>
    function makeTimer() {
        let endTime = new Date('{{game.end|date:"U"}}' * 1000);
        endTime = (Date.parse(endTime) / 1000);

        const now = (Date.parse(new Date()) / 1000);

        let timeLeft = endTime - now;

        let days = Math.floor(timeLeft / 86400);
        let hours = Math.floor((timeLeft - (days * 86400)) / 3600);
        let minutes = Math.floor((timeLeft - (days * 86400) - (hours * 3600)) / 60);
        let seconds = Math.floor((timeLeft - (days * 86400) - (hours * 3600) - (minutes * 60)));

        if (hours < "10") { hours = "0" + hours; }
        if (minutes < "10") { minutes = "0" + minutes; }
        if (seconds < "10") { seconds = "0" + seconds; }

        $("#days").html(days + " Days");
        $("#hours").html(hours + " Hours");
        $("#minutes").html(minutes + " Minutes");
        $("#seconds").html(seconds + " Seconds");

    }
    makeTimer();
    setInterval(makeTimer, 1000);
</script>
{% endif %}
{% endblock %}